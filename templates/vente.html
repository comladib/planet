
{% extends "base.html" %}

{% block title %}Vente - Gestion de Stock{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Nouvelle Vente</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Informations de vente</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('effectuer_vente') }}" method="post" id="formVente">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="client_id" class="form-label">Client</label>
                            <select class="form-select" id="client_id" name="client_id" required>
                                <option value="">Sélectionner un client</option>
                                {% for client in clients %}
                                    <option value="{{ client.id }}">{{ client.nom }} {{ client.prenom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="ecran_id" class="form-label">Écran</label>
                            <select class="form-select" id="ecran_id" name="ecran_id" required>
                                <option value="">Sélectionner un écran</option>
                                {% for ecran in ecrans %}
                                    <option value="{{ ecran.id }}" data-prix="{{ ecran.prix_vente }}" data-quantite="{{ ecran.quantite }}">{{ ecran.marque.nom }} - {{ ecran.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="barcode_recherche" class="form-label">Recherche par Barcode</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="barcode_recherche" placeholder="Scanner ou entrer le barcode">
                                <button class="btn btn-outline-secondary" type="button" id="btn_recherche_barcode">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="quantite" class="form-label">Quantité</label>
                            <input type="number" class="form-control" id="quantite" name="quantite" min="1" value="1" required>
                            <div id="info_stock" class="form-text"></div>
                        </div>
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5>Total: <span id="total">0.00</span> TND</h5>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-shopping-cart"></i> Effectuer la vente
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Détails du produit</h5>
            </div>
            <div class="card-body">
                <div id="details_produit" class="text-center text-muted">
                    <p>Sélectionnez un produit pour voir les détails</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recherche rapide par nom d'écran</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-10">
                        <input type="text" class="form-control" id="recherche_nom_ecran" placeholder="Entrez le nom de l'écran à rechercher">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="btn_recherche_nom">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                </div>
                <div id="resultats_recherche" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Mettre à jour le prix total lorsque l'écran ou la quantité change
        $('#ecran_id, #quantite').change(function() {
            updateTotal();
            updateStockInfo();
        });

        // Mettre à jour les détails du produit lorsque l'écran change
        $('#ecran_id').change(function() {
            updateDetailsProduit();
        });

        // Recherche par barcode
        $('#btn_recherche_barcode').click(function() {
            const barcode = $('#barcode_recherche').val().trim();
            if (barcode) {
                $.get("{{ url_for('recherche_ecran_barcode') }}", {barcode: barcode}, function(data) {
                    if (data.error) {
                        alert('Écran non trouvé!');
                    } else {
                        // Sélectionner l'écran trouvé
                        $('#ecran_id').val(data.id);
                        updateDetailsProduit();
                        updateTotal();
                        updateStockInfo();

                        // Réinitialiser le champ de recherche
                        $('#barcode_recherche').val('');
                    }
                });
            }
        });

        // Recherche par nom d'écran
        $('#btn_recherche_nom').click(function() {
            const terme = $('#recherche_nom_ecran').val().trim();
            if (terme) {
                // Filtrer les écrans qui correspondent au terme de recherche
                const resultats = [];
                $('#ecran_id option').each(function() {
                    if ($(this).text().toLowerCase().includes(terme.toLowerCase()) && $(this).val() !== '') {
                        resultats.push({
                            id: $(this).val(),
                            nom: $(this).text(),
                            prix: $(this).data('prix'),
                            quantite: $(this).data('quantite')
                        });
                    }
                });

                // Afficher les résultats
                let html = '';
                if (resultats.length > 0) {
                    html = '<div class="list-group">';
                    resultats.forEach(function(ecran) {
                        html += `
                            <a href="#" class="list-group-item list-group-item-action ecran-resultat" 
                                data-id="${ecran.id}" data-prix="${ecran.prix}" data-quantite="${ecran.quantite}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${ecran.nom}</h6>
                                    <small>${ecran.prix} TND</small>
                                </div>
                                <small>Quantité en stock: ${ecran.quantite}</small>
                            </a>
                        `;
                    });
                    html += '</div>';
                } else {
                    html = '<p class="text-muted">Aucun écran trouvé correspondant à votre recherche.</p>';
                }

                $('#resultats_recherche').html(html);

                // Ajouter un gestionnaire d'événements pour les résultats
                $('.ecran-resultat').click(function(e) {
                    e.preventDefault();
                    const id = $(this).data('id');
                    $('#ecran_id').val(id);
                    updateDetailsProduit();
                    updateTotal();
                    updateStockInfo();

                    // Faire défiler jusqu'au formulaire
                    $('html, body').animate({
                        scrollTop: $('#formVente').offset().top - 100
                    }, 500);
                });
            }
        });

        // Soumettre le formulaire avec la touche Entrée dans le champ de recherche par barcode
        $('#barcode_recherche').keypress(function(e) {
            if (e.which == 13) {
                $('#btn_recherche_barcode').click();
                return false;
            }
        });

        // Soumettre la recherche par nom avec la touche Entrée
        $('#recherche_nom_ecran').keypress(function(e) {
            if (e.which == 13) {
                $('#btn_recherche_nom').click();
                return false;
            }
        });

        // Fonction pour mettre à jour le total
        function updateTotal() {
            const ecranId = $('#ecran_id').val();
            const quantite = parseInt($('#quantite').val()) || 0;

            if (ecranId) {
                const prix = parseFloat($(`#ecran_id option[value="${ecranId}"]`).data('prix')) || 0;
                const total = prix * quantite;
                $('#total').text(total.toFixed(2));
            } else {
                $('#total').text('0.00');
            }
        }

        // Fonction pour mettre à jour les informations de stock
        function updateStockInfo() {
            const ecranId = $('#ecran_id').val();
            const quantite = parseInt($('#quantite').val()) || 0;

            if (ecranId) {
                const stock = parseInt($(`#ecran_id option[value="${ecranId}"]`).data('quantite')) || 0;
                $('#info_stock').text(`Stock disponible: ${stock}`);

                if (quantite > stock) {
                    $('#info_stock').addClass('text-danger');
                    $('#quantite').attr('max', stock);
                } else {
                    $('#info_stock').removeClass('text-danger');
                }
            } else {
                $('#info_stock').text('');
            }
        }

        // Fonction pour mettre à jour les détails du produit
        function updateDetailsProduit() {
            const ecranId = $('#ecran_id').val();

            if (ecranId) {
                const ecranOption = $(`#ecran_id option[value="${ecranId}"]`);
                const nom = ecranOption.text();
                const prix = ecranOption.data('prix');
                const stock = ecranOption.data('quantite');

                // Extraire le nom de la marque et le nom de l'écran
                const parties = nom.split(' - ');
                const marque = parties[0];
                const nomEcran = parties[1];

                $('#details_produit').html(`
                    <div class="row">
                        <div class="col-md-3">
                            <h6>Marque</h6>
                            <p>${marque}</p>
                        </div>
                        <div class="col-md-3">
                            <h6>Écran</h6>
                            <p>${nomEcran}</p>
                        </div>
                        <div class="col-md-3">
                            <h6>Prix de vente</h6>
                            <p>${prix} TND</p>
                        </div>
                        <div class="col-md-3">
                            <h6>Quantité en stock</h6>
                            <p>${stock}</p>
                        </div>
                    </div>
                `);
            } else {
                $('#details_produit').html('<p class="text-muted">Sélectionnez un produit pour voir les détails</p>');
            }
        }
    });
</script>
{% endblock %}
